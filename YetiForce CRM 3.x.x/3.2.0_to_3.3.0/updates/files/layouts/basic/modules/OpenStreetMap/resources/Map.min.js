
jQuery.Class("OpenStreetMap_Map_Js",{},{container:false,mapInstance:false,selectedParams:false,layerMarkers:false,markers:false,polygonLayer:false,routeLayer:false,setSelectedParams:function(a){this.selectedParams=a},registerMap:function(c,a){var b=L.map("mapid").setView(c,a);L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'}).addTo(b);this.mapInstance=b;return b},setMarkersByResponse:function(f){var k=[];var n=f.result.coordinates;var c=this.container;var b=this.mapInstance;var g=L.markerClusterGroup({maxClusterRadius:10});b.removeLayer(this.layerMarkers);n.forEach(function(p){k.push([p.lat,p.lon]);var o=L.marker([p.lat,p.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:p.color})}).bindPopup(p.label);g.addLayer(o)});b.removeLayer(this.polygonLayer);if(typeof f.result.coordinatesCeneter!="undefined"){if(typeof f.result.coordinatesCeneter.error=="undefined"){var j=c.find(".radius").val();k.push([f.result.coordinatesCeneter.lat,f.result.coordinatesCeneter.lon]);var d='<span class="description">'+c.find(".searchValue").val()+'</span><br><input type=hidden class="coordinates" data-lon="'+f.result.coordinatesCeneter.lon+'" data-lat="'+f.result.coordinatesCeneter.lat+'">';d+='<button class="btn btn-success btn-xs startTrack marginRight10"><span class="fa fa-truck"></span></button>';d+='<button class="btn btn-danger btn-xs endTrack"><span class="fa fa-flag-checkered"></span></button>';var h=L.marker([f.result.coordinatesCeneter.lat,f.result.coordinatesCeneter.lon],{icon:L.AwesomeMarkers.icon({icon:"search",markerColor:"red",prefix:"fa",})}).bindPopup(d);g.addLayer(h);if($.isNumeric(j)){j=parseInt(j)*1000;var a=L.circle([f.result.coordinatesCeneter.lat,f.result.coordinatesCeneter.lon],j,{color:"red",fillColor:"#f03",fillOpacity:0.05});this.polygonLayer=L.featureGroup([a]);b.addLayer(this.polygonLayer)}}else{var e={title:app.vtranslate("JS_LBL_PERMISSION"),text:f.result.coordinatesCeneter.error,type:"error",animation:"show"};Vtiger_Helper_Js.showMessage(e)}}this.markers=n;this.layerMarkers=g;b.addLayer(g);var m=this.container.find(".modal-footer");if(typeof f.result.legend!="undefined"){var i="";var l=f.result.legend;l.forEach(function(o){i+='<div class="pull-left"><span class="leegendIcon" style="background:'+o.color+'"></span> '+o.value+"</div>"});m.html(i)}else{m.html("")}if(k.length){b.fitBounds(k)}this.container.find(".groupNeighbours").prop("checked",true)},showCalculateBtn:function(){var b=this.container;var a=b.find(".end").val();var c=b.find(".start").val();if(a.length>0&&c.length>0){b.find(".calculateTrack").removeClass("hide")}},registerBasicModal:function(){var d=this;var a=this.container;var e=d.mapInstance;a.find(".groupBy").on("click",function(){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var g={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),groupBy:a.find(".fieldsToGroup").val(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(g,d.selectedParams);AppConnector.request(g).then(function(h){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(h)})});a.find(".groupNeighbours").on("change",function(i){var h=$(i.currentTarget);e.removeLayer(d.layerMarkers);var j=d.markers;if(h.is(":checked")){var f=L.markerClusterGroup({maxClusterRadius:10});j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);f.addLayer(k)})}else{var g=[];j.forEach(function(l){var k=L.marker([l.lat,l.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:l.color})}).bindPopup(l.label);g.push(k)});var f=L.featureGroup(g)}d.layerMarkers=f;e.addLayer(f)});a.find(".searchBtn").on("click",function(g){var f=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var h={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),searchValue:a.find(".searchValue").val(),radius:a.find(".radius").val()};$.extend(h,d.selectedParams);AppConnector.request(h).then(function(i){f.progressIndicator({mode:"hide"});d.setMarkersByResponse(i)})});var b=false;a.on("click",".startTrack",function(k){e.removeLayer(b);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".start");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"truck",markerColor:"green",prefix:"fa",})}).bindPopup(g.html());b=L.featureGroup([f]);e.addLayer(b);d.showCalculateBtn()});var c=false;a.on("click",".endTrack",function(k){e.removeLayer(c);var j=$(k.currentTarget);var g=j.closest(".leaflet-popup-content");var i=g.find(".description").html();var h=a.find(".end");var l=g.find(".coordinates");var i=i.replace(/\<br\>/gi,", ");h.val(i);h.data("lat",l.data("lat"));h.data("lon",l.data("lon"));var f=L.marker([l.data("lat"),l.data("lon")],{icon:L.AwesomeMarkers.icon({icon:"flag-checkered",markerColor:"red",prefix:"fa",})}).bindPopup(g.html());c=L.featureGroup([f]);e.addLayer(c);d.showCalculateBtn()});a.on("click",".searchInRadius",function(i){e.removeLayer(c);var h=$(i.currentTarget);var f=h.closest(".leaflet-popup-content");var k=f.find(".coordinates");var g=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var j={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),radius:a.find(".radius").val(),lat:k.data("lat"),lon:k.data("lon"),};$.extend(j,d.selectedParams);AppConnector.request(j).then(function(l){g.progressIndicator({mode:"hide"});d.setMarkersByResponse(l)})});a.find(".calculateTrack").on("click",function(){var f=a.find(".end");var g=a.find(".start");var h=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var i={url:"index.php",data:{module:"OpenStreetMap",action:"GetRoute",flon:g.data("lon"),flat:g.data("lat"),tlon:f.data("lon"),tlat:f.data("lat")},dataType:"html"};AppConnector.request(i).then(function(k){h.progressIndicator({mode:"hide"});e.removeLayer(d.routeLayer);var k=JSON.parse(k);var j=L.geoJson(k);d.routeLayer=L.featureGroup([j]);e.addLayer(d.routeLayer);a.find(".descriptionContainer").removeClass("hide");a.find(".descriptionContent .instruction").html(k.properties.description);a.find(".descriptionContent .distance").html(app.parseNumberToShow(k.properties.distance));a.find(".descriptionContent .travelTime").html(app.parseNumberToShow(k.properties.traveltime/60))})});a.find(".setView").on("click",function(h){var g=$(h.currentTarget);var j=g.closest(".input-group").find(".end,.start");var f=j.data("lat");var i=j.data("lon");if(!(typeof f=="undefined"&&typeof i=="undefined")){e.setView(new L.LatLng(f,i),14)}})},registerModalView:function(a){var d=this;var e=jQuery.progressIndicator({position:a,blockInfo:{enabled:true}});var c=$("body").height();this.container=a;var g=[0,0];var b=2;$("#mapid").css({height:c-200});this.registerMap(g,b);var f={module:"OpenStreetMap",action:"GetMarkers",srcModule:app.getModuleName(),};$.extend(f,this.selectedParams);AppConnector.request(f).then(function(h){e.progressIndicator({mode:"hide"});d.setMarkersByResponse(h);d.registerBasicModal()})},registerDetailView:function(a){this.container=a;var f=a.find("#coordinates").val();f=JSON.parse(f);var h=[0,0];var b=2;if(f.length){h=f[0];b=6}var g=$("#mapid").position();var c=$(".footerContainer ").position();$("#mapid").css({height:c.top-g.top-281});var e=this.registerMap(h,b);var d=L.markerClusterGroup({maxClusterRadius:10});f.forEach(function(j){var i=L.marker([j.lat,j.lon],{icon:L.AwesomeMarkers.icon({icon:"home",markerColor:"blue",prefix:"fa",iconColor:j.color})}).bindPopup(j.label);d.addLayer(i)});e.addLayer(d)}});