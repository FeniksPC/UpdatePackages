
jQuery.Class("Home_NotificationsList_Js",{setAsMarked:function(c){var a=this;var b={module:app.getModuleName(),action:"Notification",mode:"setMark",id:c};AppConnector.request(b).then(function(f){var g=$('.noticeRow[data-id="'+c+'"]');Vtiger_Helper_Js.showPnotify({title:app.vtranslate("JS_MESSAGE"),text:app.vtranslate("JS_MARKED_AS_READ"),type:"info"});if(f.result=="hide"){g.fadeOut(300,function(){g.remove();a.checkHiddenBlock()})}var d=$(".notificationsNotice .badge");var e=parseInt(d.text())-1;if(e>0){d.text(e)}else{d.text("")}})},checkHiddenBlock:function(){var a=this;$(".notificationEntries").each(function(b){var c=$(this);if(c.find(".noticeRow").length==0){c.closest(".panel").hide()}})},},{jstreeInstance:false,registerButtons:function(){var a=this;$(".notificationConf").on("click",function(){var c=jQuery.progressIndicator();var b="index.php?module="+app.getModuleName()+"&view=NotificationConfig";app.showModalWindow(null,b,function(d){c.progressIndicator({mode:"hide"});a.registerEventForModal(d)})});this.registerNotifications()},registerEventForModal:function(a){app.showBtnSwitch(a.find(".switchBtn"));app.showPopoverElementView(a.find(".infoPopover"));a.on("switchChange.bootstrapSwitch",".sendNotificationsSwitch",function(c,b){if(b){a.find(".schedule").removeClass("hide")}else{a.find(".schedule").addClass("hide")}});a.find('[name="saveButton"]').on("click",function(){var d=[];a.find(".watchingModule").each(function(){var e=$(this);if(e.is(":checked")){d.push(e.data("nameModule"))}});var c={module:app.getModuleName(),action:"Notification",mode:"saveWatchingModules",selctedModules:d,sendNotifications:a.find(".sendNotificationsSwitch").prop("checked")?1:0,frequency:a.find('select[name="frequency"]').val()};var b=jQuery.progressIndicator();AppConnector.request(c).then(function(e){b.progressIndicator({mode:"hide"});app.hideModalWindow()})});a.find(".selectAllModules").on("click",function(){if($(this).is(":checked")){var b=true}else{var b=false}a.find(".watchingModule").each(function(){$(this).prop("checked",b)})})},registerNotifications:function(){var a=this;$(".notificationsNotice .sendNotification").click(function(b){var c={url:"index.php?module=Home&view=CreateNotificationModal",id:"CreateNotificationModal",cb:function(d){var f,i,e,h;i=d.find("#notificationMessage");f=d.find("form");d.find("#notificationTitle").val(app.getPageTitle());e=$("<a/>",{name:"link",href:window.location.href,text:app.vtranslate("JS_NOTIFICATION_LINK")});h=$("<div>").append(e.clone()).html();i.val("<br/><hr/>"+h);var g=new Vtiger_CkEditor_Js();g.loadCkEditor(i);d.find(".externalMail").click(function(k){if(f.validationEngine("validate")){var j=CKEDITOR.instances.notificationMessage;var l=$("<div>"+j.getData()+"</div>");l.find("a[href]").each(function(o,p){var n=$(this);n.text(n.attr("href"))});var m=[];d.find("#notificationUsers option:selected").each(function(n){m.push($(this).data("mail"))});$(this).attr("href","mailto:"+m.join()+"?subject="+encodeURIComponent(d.find("#notificationTitle").val())+"&body="+encodeURIComponent(l.text()));app.hideModalWindow(d,"CreateNotificationModal")}else{k.preventDefault()}});d.find('[type="submit"]').click(function(k){var j=$(this);f.find('[name="mode"]').val(j.data("mode"))});f.submit(function(j){if(f.validationEngine("validate")){app.hideModalWindow(d,"CreateNotificationModal")}})},};app.showModalWindow(c)})},loadNotification:function(b){var c=this;var d={module:app.getModuleName(),view:app.getViewName(),types:b,};var a=jQuery.progressIndicator();AppConnector.request(d).then(function(e){$(".notificationContainer").html(e);a.progressIndicator({mode:"hide"});app.registerDataTables($(".notificationTable"))})},registerJstreeEvents:function(){var b=this;var a=app.moduleCacheGet("selectedTypesNotifications");a=JSON.parse(a);b.jstreeInstance.on("loaded.jstree",function(c,d){if(a==null){b.jstreeInstance.jstree("select_all")}else{d.instance.select_node(a)}b.jstreeInstance.on("changed.jstree",function(i,h){var j=b.jstreeInstance.jstree("get_selected",true);var f=[];var g=[];$.each(j,function(){f.push(this.original.record_id);g.push(this.id)});app.moduleCacheSet("selectedTypesNotifications",JSON.stringify(g));b.loadNotification(f)})})},registerJstree:function(){var a=$(".siteBarContent ");var b=a.find('[name="notificationTypes"]').val();this.jstreeInstance=a.find("#jstreeContainer");this.jstreeInstance.jstree({core:{data:JSON.parse(b),themes:{name:"proton",responsive:true}},plugins:["checkbox"]});this.registerJstreeEvents()},registerEvents:function(){this.registerButtons();this.registerJstree();app.registerDataTables($(".notificationTable"))}});