jQuery.Class("Settings_PickListDependency_Js",{pickListDependencyInstance:false,triggerAdd:function(event){event.stopPropagation();var instance=Settings_PickListDependency_Js.pickListDependencyInstance;instance.updatedSourceValues=[];instance.showEditView(instance.listViewForModule).done(function(data){instance.registerAddViewEvents()})},triggerEdit:function(event,module,sourceField,targetField){event.stopPropagation();var instance=Settings_PickListDependency_Js.pickListDependencyInstance;instance.updatedSourceValues=[];instance.showEditView(module,sourceField,targetField).done(function(data){var form=jQuery("#pickListDependencyForm");form.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",true);var element=form.find(".dependencyMapping");app.showHorizontalScrollBar(element);instance.registerDependencyGraphEvents();instance.registerSubmitEvent()})},triggerDelete:function(event,module,sourceField,targetField){event.stopPropagation();var currentTarget=jQuery(event.currentTarget);var currentTrEle=currentTarget.closest("tr");var instance=Settings_PickListDependency_Js.pickListDependencyInstance;var message=app.vtranslate("JS_LBL_ARE_YOU_SURE_YOU_WANT_TO_DELETE");Vtiger_Helper_Js.showConfirmationBox({message:message}).done(function(e){instance.deleteDependency(module,sourceField,targetField).done(function(data){var params={};params.text=app.vtranslate("JS_DEPENDENCY_DELETED_SUEESSFULLY");Settings_Vtiger_Index_Js.showMessage(params);currentTrEle.fadeOut("slow").remove()})})}},{init:function(){Settings_PickListDependency_Js.pickListDependencyInstance=this},listViewForModule:"",updatedSourceValues:[],valueMapping:[],selectedSourceValues:[],showEditView:function(module,sourceField,targetField){var aDeferred=jQuery.Deferred();var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var params={};params["module"]=app.getModuleName();params["parent"]=app.getParentModuleName();params["view"]="Edit";params["sourceModule"]=module;params["sourcefield"]=sourceField;params["targetfield"]=targetField;AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});var container=jQuery(".contentsDiv");container.html(data);App.Fields.Picklist.showSelect2ElementView(container.find("select.select2"),{dropdownCss:{"z-index":0}});aDeferred.resolve(data)}).fail(function(error){progressIndicatorElement.progressIndicator({mode:"hide"});aDeferred.reject(error)});return aDeferred.promise()},getModuleDependencyGraph:function(form){var thisInstance=this;form.find('[name="sourceModule"]').on("change",function(){var forModule=form.find('[name="sourceModule"]').val();thisInstance.showEditView(forModule).done(function(data){thisInstance.registerAddViewEvents()})})},registerPicklistFieldsChangeEvent:function(form){var thisInstance=this;form.find('[name="sourceField"],[name="targetField"]').on("change",function(){thisInstance.checkValuesForDependencyGraph(form)})},checkValuesForDependencyGraph:function(form){var thisInstance=this;var sourceField=form.find('[name="sourceField"]');var targetField=form.find('[name="targetField"]');var select2SourceField=app.getSelect2ElementFromSelect(sourceField);var select2TargetField=app.getSelect2ElementFromSelect(targetField);var sourceFieldValue=sourceField.val();var targetFieldValue=targetField.val();var dependencyGraph=jQuery("#dependencyGraph");if(sourceFieldValue!=""&&targetFieldValue!=""){var result=app.vtranslate("JS_SOURCE_AND_TARGET_FIELDS_SHOULD_NOT_BE_SAME");form.find(".errorMessage").addClass("d-none");if(sourceFieldValue==targetFieldValue){select2TargetField.validationEngine("showPrompt",result,"error","topLeft",true);dependencyGraph.html("")}else{select2SourceField.validationEngine("hide");select2TargetField.validationEngine("hide");var sourceModule=form.find('[name="sourceModule"]').val();var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});thisInstance.checkCyclicDependency(sourceModule,sourceFieldValue,targetFieldValue).done(function(data){var result=data["result"];if(!result["result"]){thisInstance.addNewDependencyPickList(sourceModule,sourceFieldValue,targetFieldValue);progressIndicatorElement.progressIndicator({mode:"hide"})}else{progressIndicatorElement.progressIndicator({mode:"hide"});form.find(".errorMessage").removeClass("d-none");form.find(".cancelAddView").removeClass("d-none");dependencyGraph.html("")}}).fail(function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"})})}}else{form.find(".errorMessage").addClass("d-none");var result=app.vtranslate("JS_SELECT_SOME_VALUE");if(sourceFieldValue==""){select2SourceField.validationEngine("showPrompt",result,"error","topLeft",true)}else if(targetFieldValue==""){select2TargetField.validationEngine("showPrompt",result,"error","topLeft",true)}}},checkCyclicDependency:function(sourceModule,sourceFieldValue,targetFieldValue){var aDeferred=jQuery.Deferred();var params={};params["mode"]="checkCyclicDependency";params["module"]=app.getModuleName();params["parent"]=app.getParentModuleName();params["action"]="Index";params["sourceModule"]=sourceModule;params["sourcefield"]=sourceFieldValue;params["targetfield"]=targetFieldValue;AppConnector.request(params).done(function(data){aDeferred.resolve(data)},function(error,err){aDeferred.reject()});return aDeferred.promise()},addNewDependencyPickList:function(sourceModule,sourceFieldValue,targetFieldValue){var thisInstance=this;thisInstance.updatedSourceValues=[];var params={};params["mode"]="getDependencyGraph";params["module"]=app.getModuleName();params["parent"]=app.getParentModuleName();params["view"]="IndexAjax";params["sourceModule"]=sourceModule;params["sourcefield"]=sourceFieldValue;params["targetfield"]=targetFieldValue;AppConnector.request(params).done(function(data){var dependencyGraph=jQuery("#dependencyGraph");dependencyGraph.html(data).css({padding:"10px",border:"1px solid #ddd",background:"#fff"});var element=dependencyGraph.find(".dependencyMapping");app.showHorizontalScrollBar(element);thisInstance.registerDependencyGraphEvents()})},deleteDependency:function(module,sourceField,targetField){var aDeferred=jQuery.Deferred();var params={};params["module"]=app.getModuleName();params["parent"]=app.getParentModuleName();params["action"]="DeleteAjax";params["sourceModule"]=module;params["sourcefield"]=sourceField;params["targetfield"]=targetField;AppConnector.request(params).done(function(data){aDeferred.resolve(data)}).fail(function(error,err){aDeferred.reject(error,err)});return aDeferred.promise()},registerCancelAddView:function(form){var thisInstance=this;var cancelDiv=form.find(".cancelAddView");cancelDiv.removeClass("d-none");cancelDiv.find(".cancelLink").on("click",function(){thisInstance.loadListViewContents(thisInstance.listViewForModule)})},registerAddViewEvents:function(){var thisInstance=this;var form=jQuery("#pickListDependencyForm");thisInstance.registerCancelAddView(form);thisInstance.getModuleDependencyGraph(form);thisInstance.registerPicklistFieldsChangeEvent(form);thisInstance.registerSubmitEvent()},registerDependencyGraphEvents:function(){var thisInstance=this;var form=jQuery("#pickListDependencyForm");var dependencyGraph=jQuery("#dependencyGraph");form.find(".cancelAddView").addClass("d-none");thisInstance.registerTargetFieldsClickEvent(dependencyGraph);thisInstance.registerTargetFieldsUnmarkAll(dependencyGraph);thisInstance.registerSelectSourceValuesClick(dependencyGraph);thisInstance.registerCancelDependency(form)},registerListViewEvents:function(){var thisInstance=this;var forModule=jQuery(".contentsDiv").find(".pickListSupportedModules").val();thisInstance.listViewForModule=forModule;thisInstance.registerSourceModuleChangeEvent()},registerCancelDependency:function(form){var thisInstance=this;var cancelDependencyLink=form.find(".cancelDependency");cancelDependencyLink.on("click",function(){thisInstance.loadListViewContents(thisInstance.listViewForModule)})},registerTargetFieldsClickEvent:function(dependencyGraph){var thisInstance=this;thisInstance.updatedSourceValues=[];dependencyGraph.find("td.picklistValueMapping").on("click",function(e){var currentTarget=jQuery(e.currentTarget);var sourceValue=currentTarget.data("sourceValue");if(jQuery.inArray(sourceValue,thisInstance.updatedSourceValues)==-1){thisInstance.updatedSourceValues.push(sourceValue)}if(currentTarget.hasClass("selectedCell")){currentTarget.addClass("unselectedCell").removeClass("selectedCell").find("[data-fa-i2svg]").remove()}else{currentTarget.addClass("selectedCell").removeClass("unselectedCell").prepend('<i class="fas fa-check float-left"></i>')}})},registerTargetFieldsUnmarkAll:function(dependencyGraph){var thisInstance=this;thisInstance.updatedSourceValues=[];dependencyGraph.find(".unmarkAll").on("click",function(e){dependencyGraph.find("td.picklistValueMapping").each(function(index){var currentTarget=jQuery(this);var sourceValue=currentTarget.data("sourceValue");if(jQuery.inArray(sourceValue,thisInstance.updatedSourceValues)==-1){thisInstance.updatedSourceValues.push(sourceValue)}currentTarget.addClass("unselectedCell").removeClass("selectedCell").find("[data-fa-i2svg]").remove()})})},updateValueMapping:function(dependencyGraph){var thisInstance=this;thisInstance.valueMapping=[];var sourceValuesArray=thisInstance.updatedSourceValues;var dependencyTable=dependencyGraph.find(".pickListDependencyTable");for(var key in sourceValuesArray){if(typeof sourceValuesArray[key]=="string"){var encodedSourceValue=sourceValuesArray[key].replace(/"/g,'\\"')}else{encodedSourceValue=sourceValuesArray[key]}var selectedTargetValues=dependencyTable.find('td[data-source-value="'+encodedSourceValue+'"]').filter(".selectedCell");var targetValues=[];if(selectedTargetValues.length>0){jQuery.each(selectedTargetValues,function(index,element){targetValues.push(jQuery(element).data("targetValue"))})}else{targetValues.push("")}thisInstance.valueMapping.push({sourcevalue:sourceValuesArray[key],targetvalues:targetValues})}},registerSelectSourceValuesClick:function(dependencyGraph){var thisInstance=this;dependencyGraph.find("button.sourceValues").on("click",function(){var selectSourceValues=dependencyGraph.find(".modalCloneCopy");var clonedContainer=selectSourceValues.clone(true,true).removeClass("modalCloneCopy");var callBackFunction=function(data){data.find(".sourcePicklistValuesModal").removeClass("d-none");data.find('[name="saveButton"]').on("click",function(e){thisInstance.selectedSourceValues=[];var sourceValues=data.find(".sourceValue");jQuery.each(sourceValues,function(index,ele){var element=jQuery(ele);var value=element.val();var encodedValue;if(typeof value=="string"){encodedValue=value.replace(/"/g,'\\"')}else{encodedValue=value}var hiddenElement=selectSourceValues.find('[type="checkbox"].sourceValue.'+encodedValue);if(element.is(":checked")){thisInstance.selectedSourceValues.push(value);hiddenElement.prop("checked",true)}else{hiddenElement.prop("checked",false)}});app.hideModalWindow();thisInstance.loadMappingForSelectedValues(dependencyGraph)})};app.showModalWindow(clonedContainer,function(data){if(typeof callBackFunction=="function"){callBackFunction(data)}},{width:"1000px"})})},loadMappingForSelectedValues:function(dependencyGraph){var thisInstance=this;var allSourcePickListValues=JSON.parse(dependencyGraph.find(".allSourceValues").val());var dependencyTable=dependencyGraph.find(".pickListDependencyTable");for(var key in allSourcePickListValues){if(typeof allSourcePickListValues[key]=="string"){var encodedSourcePickListValue=allSourcePickListValues[key].replace(/"/g,'\\"')}else{encodedSourcePickListValue=allSourcePickListValues[key]}var mappingCells=dependencyTable.find('[data-source-value="'+encodedSourcePickListValue+'"]');if(jQuery.inArray(allSourcePickListValues[key],thisInstance.selectedSourceValues)==-1){mappingCells.hide()}else{mappingCells.show()}}dependencyGraph.find(".dependencyMapping").mCustomScrollbar("update")},savePickListDependency:function(form){var thisInstance=this;var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var data=form.serializeFormData();data["module"]=app.getModuleName();data["parent"]=app.getParentModuleName();data["action"]="SaveAjax";data["mapping"]=JSON.stringify(thisInstance.valueMapping);AppConnector.request(data).done(function(data){if(data["success"]){progressIndicatorElement.progressIndicator({mode:"hide"});var params={};params.text=app.vtranslate("JS_PICKLIST_DEPENDENCY_SAVED");Settings_Vtiger_Index_Js.showMessage(params);thisInstance.loadListViewContents(thisInstance.listViewForModule)}}).fail(function(error){progressIndicatorElement.progressIndicator({mode:"hide"})})},loadListViewContents:function(forModule){var thisInstance=this;var progressIndicatorElement=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var params={};params["module"]=app.getModuleName();params["parent"]=app.getParentModuleName();params["view"]="List";params["formodule"]=forModule;AppConnector.requestPjax(params).done(function(data){progressIndicatorElement.progressIndicator({mode:"hide"});jQuery(".contentsDiv").html(data);App.Fields.Picklist.changeSelectElementView(jQuery(".contentsDiv").find(".pickListSupportedModules"));thisInstance.registerListViewEvents()}).fail(function(error,err){progressIndicatorElement.progressIndicator({mode:"hide"})})},triggerDisplayTypeEvent:function(){var widthType=app.cacheGet("widthType","narrowWidthType");if(widthType){var elements=jQuery(".listViewEntriesTable").find("td,th");elements.attr("class",widthType)}},registerSourceModuleChangeEvent:function(){var thisInstance=this;var container=jQuery(".contentsDiv");container.find(".pickListSupportedModules").on("change",function(e){var currentTarget=jQuery(e.currentTarget);var forModule=currentTarget.val();thisInstance.loadListViewContents(forModule)})},registerSubmitEvent:function(){var thisInstance=this;var form=jQuery("#pickListDependencyForm");var dependencyGraph=jQuery("#dependencyGraph");form.on("submit",function(e){e.preventDefault();try{thisInstance.updateValueMapping(dependencyGraph)}catch(e){bootbox.alert(e.message);return}if(form.find(".editDependency").val()!="true"&&thisInstance.valueMapping.length<1){var params={};params.text=app.vtranslate("JS_PICKLIST_DEPENDENCY_NO_SAVED");params.type="info";Settings_Vtiger_Index_Js.showMessage(params)}else{thisInstance.savePickListDependency(form)}})},registerEvents:function(){var thisInstance=this;var form=jQuery("#pickListDependencyForm");if(form.length>0){var element=form.find(".dependencyMapping");app.showHorizontalScrollBar(element);if(form.find(".editDependency").val()=="true"){form.find('select[name="sourceModule"],select[name="sourceField"],select[name="targetField"]').prop("disabled",true);thisInstance.registerDependencyGraphEvents();thisInstance.registerSubmitEvent()}else{thisInstance.registerAddViewEvents()}}else{thisInstance.registerListViewEvents()}}});jQuery(document).ready(function(){var instance=new Settings_PickListDependency_Js;instance.registerEvents()});