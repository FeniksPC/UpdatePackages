Vtiger_BasicSearch_Js("Vtiger_AdvanceSearch_Js",{cache:{}},{elementContainer:false,advanceFilter:false,filterValidationRegistered:false,filterForm:false,parentContainer:false,getContainer:function(){return this.elementContainer},setContainer:function(container){this.elementContainer=container;return this},getParentContainer:function(){return this.parentContainer},setParentContainer:function(container){this.setMainContainer(container);this.parentContainer=container;return this},getFilterForm:function(){return $('form[name="advanceFilterForm"]',this.getContainer())},getAdvanceSearch:function(){var aDeferred=$.Deferred();var searchModule=this.getSearchModule();if(searchModule in Vtiger_AdvanceSearch_Js.cache){aDeferred.resolve(Vtiger_AdvanceSearch_Js.cache[searchModule]);return aDeferred.promise()}var searchableModulesParams={module:app.getModuleName(),searchModule:searchModule,view:"BasicAjax",mode:"showAdvancedSearch"};if(app.getParentModuleName()){searchableModulesParams.parent=app.getParentModuleName()}var progressInstance=$.progressIndicator();AppConnector.request(searchableModulesParams).then(function(data){progressInstance.hide();Vtiger_AdvanceSearch_Js.cache[searchModule]=data;aDeferred.resolve(data)},function(error,err){aDeferred.reject(error)});return aDeferred.promise()},initiateSearch:function(){var aDeferred=$.Deferred();var thisInstance=this;var postLoad=function(uiData){thisInstance.setContainer($("#advanceSearchContainer"));thisInstance.filterValidationRegistered=false;thisInstance.registerEvents();thisInstance.advanceFilter=new Vtiger_SearchAdvanceFilter_Js($(".filterContainer",uiData));aDeferred.resolve()};thisInstance.getAdvanceSearch().then(function(data){var params={};params.data=data;params.cb=postLoad;app.hideModalWindow();app.showModalWindow(params)},function(error){aDeferred.reject()});return aDeferred.promise()},getNameFields:function(){var form=this.getFilterForm();return form.find('[name="labelFields"]').data("value")},selectBasicSearchValue:function(){var parent=this.getParentContainer();if(parent==false){return false}var value=parent.find(".globalSearchValue").val();if(value.length>0){var form=this.getFilterForm();var labelFieldList=this.getNameFields();if(typeof labelFieldList==="undefined"||labelFieldList==null||labelFieldList.length==0){return}var anyConditionContainer=form.find(".anyConditionContainer");for(var index in labelFieldList){var labelFieldName=labelFieldList[index];if(index!=0){anyConditionContainer.find(".addCondition").find("button").trigger("click")}var conditionRow=anyConditionContainer.find(".conditionList").find(".conditionRow:last");var fieldSelectElemnt=conditionRow.find('select[name="columnname"]');fieldSelectElemnt.find('option[data-field-name="'+labelFieldName+'"]').attr("selected","selected");fieldSelectElemnt.trigger("change").trigger("chosen:updated");var comparatorSelectElemnt=conditionRow.find('select[name="comparator"]');comparatorSelectElemnt.find('option[value="c"]').attr("selected","selected");comparatorSelectElemnt.trigger("chosen:updated");var valueElement=conditionRow.find('[name="value"]');valueElement.val(value)}}},search:function(){var conditionValues=this.advanceFilter.getValues();var module=this.getSearchModule();return this._search({module:app.getModuleName(),searchModule:module,advfilterlist:JSON.stringify(conditionValues)})},showSearchResults:function(data){var thisInstance=this;var aDeferred=$.Deferred();var postLoad=function(data){aDeferred.resolve(data)};var html='<div class="row">'+'<span class="col-md-4 searchHolder"></span>'+'<span class="col-md-8 filterHolder marginLeftZero d-none"></span>'+"</div>";var jQhtml=$(html);$(".searchHolder",jQhtml).html(data);data=jQhtml;var params={};params.data=data;params.cb=postLoad;app.showModalWindow(params);return aDeferred.promise()},saveFilter:function(params){var aDeferred=$.Deferred();params.source_module=this.getSearchModule();params.status=1;params.advfilterlist=JSON.stringify(this.advanceFilter.getValues(false));params.module="CustomView";params.action="Save";AppConnector.request(params).then(function(data){if(!data.success){var params={title:app.vtranslate("JS_MESSAGE"),text:data.error.message,type:"error"};Vtiger_Helper_Js.showPnotify(params)}aDeferred.resolve(data)});return aDeferred.promise()},saveAndViewFilter:function(params){this.saveFilter(params).then(function(response){var url=response["result"]["listviewurl"];window.location.href=url},function(error){})},isSearchAndFilterComponentsShown:function(){var modalData=$("#"+Window.lastModalId);var filterComponent=$(".filterHolder",modalData).find("#advanceSearchContainer");if(filterComponent.length<=0){return false}return true},performSearch:function(){var thisInstance=this;var isSearchResultsAndFilterShown=this.isSearchAndFilterComponentsShown();this.search().then(function(data){thisInstance.setContainer(thisInstance.getContainer().detach());thisInstance.showSearchResults(data).then(function(modalBlock){thisInstance.registerShowFiler();if(isSearchResultsAndFilterShown){thisInstance.showFilter()}})})},showFilter:function(){var thisInstance=this;var callback=function(){app.showModalWindow(thisInstance.getContainer())};app.hideModalWindow(callback)},performValidation:function(){var thisInstance=this;this.formValidationDeferred=$.Deferred();var controlForm=this.getFilterForm();var validationDone=function(form,status){if(status){thisInstance.formValidationDeferred.resolve()}else{thisInstance.formValidationDeferred.reject()}};if(!this.filterValidationRegistered){this.filterValidationRegistered=true;controlForm.validationEngine({onValidationComplete:validationDone})}controlForm.submit();return this.formValidationDeferred.promise()},registerShowFiler:function(){var thisInstance=this;$("#showFilter").on("click",function(e){thisInstance.showFilter()})},registerEvents:function(){var thisInstance=this;var container=this.getContainer();container.on("change","#searchModuleList",function(e){var selectElement=$(e.currentTarget);var selectedModuleName=selectElement.val();thisInstance.setSearchModule(selectedModuleName);thisInstance.initiateSearch().then(function(){thisInstance.selectBasicSearchValue()})});$("#advanceSearchButton").on("click",function(e){var searchModule=thisInstance.getSearchModule();if(searchModule.length<=0){app.getChosenElementFromSelect($("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",true);return}thisInstance.performValidation().then(function(){thisInstance.performSearch()},function(){})});$("#advanceIntiateSave").on("click",function(e){var currentElement=$(e.currentTarget);currentElement.addClass("d-none");var actionsContainer=currentElement.closest(".actions");$('input[name="viewname"]',actionsContainer).removeClass("zeroOpacity").focus();$("#advanceSave").removeClass("d-none")});$("#advanceSave").on("click",function(e){var actionsContainer=$(e.currentTarget).closest(".actions");var filterNameField=$('input[name="viewname"]',actionsContainer);var value=filterNameField.val();if(value.length<=0){filterNameField.validationEngine("showPrompt",app.vtranslate("JS_REQUIRED_FIELD"),"error","topRight",true);return}var searchModule=thisInstance.getSearchModule();if(searchModule.length<=0){app.getChosenElementFromSelect($("#searchModuleList")).validationEngine("showPrompt",app.vtranslate("JS_SELECT_MODULE"),"error","topRight",true);return}thisInstance.performValidation().then(function(){var params={};params.viewname=value;thisInstance.saveAndViewFilter(params)})});this.getFilterForm().on("submit",function(e){e.preventDefault()});this.setSearchModule($("#searchModuleList").val())}});